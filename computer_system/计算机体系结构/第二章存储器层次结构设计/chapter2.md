## 第二章 存储器层次结构设计

### 多级存储器层次结构
* 典型服务器多级存储器容量和访问速度(2012年)
    * CPU寄存器: 1KB/300ps
    * L1 cache: 64KB/1ns
    * L2 cache: 256KB/3-10ns
    * L3 cache: 2-4MB/10-20ns
    * (存储器总线)内存: 4-16GB/50-100ns
    * (IO总线)磁盘: 4-16TB/5-10ms

* 典型个人移动设备多级存储器容量和访问速度(2012年)
    * CPU寄存器: 0.5KB/500ps
    * L1 cache: 64KB/2ns
    * L2 cache: 256KB/10-20ns
    * (存储器总线)内存: 256-512MB/50-100ns
    * 磁盘: 4-16TB/25-50us

* [缓存组织结构与分类](../../深入理解计算机系统/第六章存储器层次结构/chapter6.md)

* 缓存缺失场景：
    * 强制(Compulsory): 强制缺失，如一个数据块的第一次访问，一定需要将这个数据块调入缓存中
    * 容量(Capacity): 容量缺失，如果缓存不能包含程序运行时所需的全部块，定会发生有些块被放弃，然后再被调入
    * 冲突(Conflict): 冲突缺失，如果块放置策略不是全相联，定会发生多个块映射到同一个组/块中，需放弃再调入
    * 一致性(Coherency): 一致性缺失，多处理器多缓存一致性的缓存刷新。

* 存储器平均访问时间 = 命中时间 + 缺失率 * 缺失代价

### 缓存优化方法

#### 6种基本的缓存优化方法
* 增大块以降低缺失率：利用空间局部性，增大块减少强制缺失，但增加了缺失代价，可能增大容量缺失或冲突缺失
* 增大缓存降低缺失率：减少容量缺失，但是可能会延长命中时间
* 提高相联程度降低缺失率：减少冲突缺失，但是可能会延长命中时间
* 多级缓存降低缺失代价：加快缓存命中速度，跟上处理器时钟频率
* 为读取缺失指定高于写入操作的优先级，以降低缺失率
* 缓存索引避免地址转换，降低命中时间

#### 10种缓存性能高级优化方法
> * 缩短命中时间
> * 增加缓存带宽
> * 降低缺失代价
> * 降低缺失率
> * 通过并行降低缺失代价或者缺失率

* 小而简单的第一级缓存，缩短命中时间，降低功耗
    * 低相联度 -> 缩短命中时间，降低功率
        * 缓存命中关键3个步骤：
            1. 使用地址中的索引确定标记存储器的地址;
            1. 将读取的标签值与地址进行比较
            1. 若为组相联，设置多路转换器选择正确的数据项

* 路预测缩短命中时间
    * 减少冲突缺失，保持直接映射缓存命中速度的方法
    * 缓存中另外保存了一些位，用于预测下一次缓存访问组中的路或块

* 实现缓存访问的流水化，以提高缓存带宽

* 采用无阻塞缓存，提高缓存带宽
    * 等待数据缓存返回缺失数据时，处理器可以继续从指令缓存中提取指令 -> 缺失时仍然命中，降低实际缺失代价
    * 重叠多次缺失，进一步降低实际缺失代价